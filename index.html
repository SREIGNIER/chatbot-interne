<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Chatbot Interne</title>
  <script src="https://unpkg.com/tabletop@1.6.0/tabletop.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f5f5f5;
      padding: 20px;
    }
    #chatbox {
      width: 100%;
      max-width: 600px;
      margin: auto;
      background: white;
      border: 1px solid #ccc;
      padding: 20px;
      border-radius: 8px;
    }
    .message {
      margin-bottom: 10px;
    }
    .user {
      font-weight: bold;
    }
    .bot {
      color: #333;
    }
    input[type="text"] {
      width: 100%;
      padding: 10px;
      margin-top: 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    #adminPanel {
      width: 100%;
      max-width: 600px;
      margin: 30px auto 0;
      background: #fff3cd;
      border: 1px solid #ffeeba;
      padding: 20px;
      border-radius: 8px;
    }
    #adminPanel h3 {
      margin-top: 0;
    }
    #unknownList li {
      margin-bottom: 15px;
    }
  </style>
</head>
<body>
  <div id="chatbox">
    <div class="message bot">Bonjour ! Pose-moi une question sur les mÃ©thodologies internes.</div>
  </div>
  <input type="text" id="userInput" placeholder="Tape ta question ici..." />

  <div id="adminPanel">
    <h3>ðŸ“‹ Questions non reconnues</h3>
    <button onclick="loadUnknownQuestions()">ðŸ”„ RafraÃ®chir</button>
    <ul id="unknownList"></ul>
  </div>

  <script>
    const knowledgeBase = [
      {
        keywords: ["ticket", "crÃ©er", "ouvrir", "faire"],
        answer: "Pour crÃ©er un ticket, rends-toi sur l'outil interne X, clique sur 'Nouveau ticket' et remplis les champs requis."
      },
      {
        keywords: ["drive", "accÃ¨s", "accÃ©der"],
        answer: "Le drive est accessible via le lien interne drive.entreprise.fr. Utilise ton identifiant pro."
      }
    ];

    const chatbox = document.getElementById('chatbox');
    const input = document.getElementById('userInput');

    input.addEventListener('keydown', function(event) {
      if (event.key === 'Enter') {
        const question = input.value.trim().toLowerCase();
        if (!question) return;

        addMessage('user', question);
        input.value = '';

        const matchedEntry = knowledgeBase.find(entry =>
          entry.keywords.some(keyword => question.includes(keyword))
        );

        const answer = matchedEntry
          ? matchedEntry.answer
          : "Je ne connais pas encore la rÃ©ponse Ã  cette question. Veux-tu me la transmettre pour que je m'amÃ©liore ?";
        
        addMessage('bot', answer);

        if (!matchedEntry) {
          saveUnknownQuestion(question);
        }
      }
    });

    function addMessage(sender, text) {
      const message = document.createElement('div');
      message.classList.add('message', sender);
      message.innerText = (sender === 'user' ? 'Vous: ' : 'Bot: ') + text;
      chatbox.appendChild(message);
      chatbox.scrollTop = chatbox.scrollHeight;
    }

    // Envoi vers Google Sheets via Apps Script
    function saveUnknownQuestion(question) {
      fetch('https://script.google.com/macros/s/AKfycbz3yVehJULY0g82dd8Id4--ic02IxrhRBonPk_xnTaE5jZ5WG1T4coR5-EPmkxMLi0-/exec', {
        method: 'POST',
        mode: 'no-cors',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ question: question })
      })
      .then(() => console.log("Question envoyÃ©e Ã  Google Sheets :", question))
      .catch(err => console.error("Erreur dâ€™envoi :", err));
    }

    // Lecture directe depuis Google Sheets avec Tabletop.js
    function loadUnknownQuestions() {
      Tabletop.init({
        key: '1SR3AgYgM9SSgV_iRk3T27sudNwNSWkD_KKnzis8m3rA',
        simpleSheet: true,
        callback: function(data) {
          const list = document.getElementById('unknownList');
          list.innerHTML = '';

          data.forEach(entry => {
            const li = document.createElement('li');
            const date = entry.date ? new Date(entry.date).toLocaleDateString() : "(date inconnue)";
            li.textContent = `${entry.question} (le ${date})`;
            list.appendChild(li);
          });
        }
      });
    }
  </script>
</body>
</html>
