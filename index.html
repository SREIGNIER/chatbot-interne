<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Admin Chatbot</title>
  <style>
    body {
      background: #1c1c1c;
      color: white;
      font-family: Arial;
      padding: 20px;
    }
    #chatbox {
      max-width: 800px;
      margin: auto;
      padding: 20px;
      background: #111;
      border: 1px solid #444;
      border-radius: 8px;
    }
    .message {
      margin-bottom: 10px;
    }
    .user { font-weight: bold; }
    .bot { color: #ddd; }

    #userInputWrapper {
      display: flex;
      align-items: center;
      justify-content: center;
      margin-top: 20px;
    }

    #userInput {
      flex: 1;
      padding: 10px;
      border-radius: 5px;
      border: 1px solid #ccc;
      background: #111;
      color: white;
      font-size: 16px;
    }

    #fileUpload {
      display: none;
    }

    #fileLabel {
      margin-left: 10px;
      cursor: pointer;
      font-size: 22px;
    }

    #uploadStatus {
      text-align: center;
      margin-top: 10px;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <div id="chatbox">
    <div class="message bot">Bonjour Admin ! Pose-moi une question ou envoie-moi un document √† int√©grer.</div>
  </div>

  <div id="userInputWrapper">
    <input type="text" id="userInput" placeholder="Tape une question ou 'R√©ponse:' pour m'entra√Æner..." />
    <label for="fileUpload" id="fileLabel" title="Ajouter un document (PDF/DOCX)">üìé</label>
    <input type="file" id="fileUpload" accept=".pdf,.docx" />
  </div>

  <div id="uploadStatus"></div>

  <script>
    const chatbox = document.getElementById('chatbox');
    const input = document.getElementById('userInput');
    const fileUpload = document.getElementById('fileUpload');
    const statusDiv = document.getElementById('uploadStatus');

    const knowledgeBase = [
      {
        keywords: ["annuler", "annulation", "r√®glement", "reglement", "reglemet", "m√©thodologie d'annulation", "annuler un r√®glement", "erreur paiement", "supprimer r√®glement"],
        answer: `Voici la m√©thodologie pour annuler un r√®glement si erreur (le jour m√™me) :\n
1. Rendez-vous sur la vue 360 de la fiche client, cliquez sur "Fiche personne"\n
2. Dans le bandeau de gauche, allez dans "Raccourcis" > "Compte client"\n
3. Cliquez sur "Historique" (pensez √† bien saisir la soci√©t√© !)\n
4. S√©lectionnez la ligne du r√®glement √† annuler (seulement possible si la date est du jour ou J+1)\n
5. Cliquez sur "Annuler un r√®glement" > V√©rifiez les d√©tails > Cliquez sur "Valider"\n
‚úÖ Attention : les op√©rations ne peuvent √™tre annul√©es que le jour m√™me ou le lendemain.\n
üì∏ Des captures d‚Äô√©cran sont disponibles dans le document pour t‚Äôaider visuellement.`
      }
    ];

    function addMessage(sender, text) {
      const msg = document.createElement('div');
      msg.className = `message ${sender}`;
      msg.innerText = `${sender === 'user' ? 'Vous' : 'Bot'}: ${text}`;
      chatbox.appendChild(msg);
      chatbox.scrollTop = chatbox.scrollHeight;
    }

    input.addEventListener('keydown', function (e) {
      if (e.key === 'Enter') {
        const text = input.value.trim();
        if (!text) return;
        input.value = '';
        addMessage('user', text);

        if (text.toLowerCase().startsWith("r√©ponse:")) {
          const lastQuestion = chatbox.querySelectorAll('.user:last-of-type');
          fetch('https://script.google.com/macros/s/AKfycbwHSjK-ye75E1CvZMavFIo0k0yO3P9KRVD0i8b9adWQ3yAbwsJnc4V8pux1YF11jZPo/exec', {
            method: 'POST',
            mode: 'no-cors',
            body: JSON.stringify({
              question: lastQuestion?.innerText.replace("Vous: ", "") || "Inconnue",
              answer: text.replace("r√©ponse:", "").trim()
            })
          });
          addMessage('bot', "Merci ! R√©ponse enregistr√©e. Je m'en souviendrai.");
        } else {
          const match = knowledgeBase.find(kb =>
            kb.keywords.some(k => text.toLowerCase().includes(k))
          );
          if (match) {
            addMessage('bot', match.answer);
          } else {
            addMessage('bot', "Je ne connais pas encore la r√©ponse √† cette question. Si tu la connais, √©cris-la comme ceci : R√©ponse: [ta r√©ponse]");
          }
        }
      }
    });

    fileUpload.addEventListener('change', async function () {
      const file = this.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function (e) {
        const base64 = e.target.result.split(',')[1];
        fetch('https://script.google.com/macros/s/AKfycbwHSjK-ye75E1CvZMavFIo0k0yO3P9KRVD0i8b9adWQ3yAbwsJnc4V8pux1YF11jZPo/exec', {
          method: 'POST',
          mode: 'no-cors',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            uploadPDF: true,
            fileName: file.name,
            fileType: file.type,
            fileData: base64
          })
        }).then(() => {
          addMessage('bot', "‚úÖ Fichier envoy√© avec succ√®s.");
          statusDiv.innerText = "";
        }).catch(() => {
          addMessage('bot', "‚ùå Erreur d'envoi du document.");
        });
      };
      reader.readAsDataURL(file);
    });
  </script>
</body>
</html>
